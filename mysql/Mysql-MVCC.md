# Mysql MVCC



- MVCC (Multi-Version Concurrency Control) (注：与MVCC相对的，是基于锁的并发控制，Lock-Based Concurrency Control)是一种基于多版本的并发控制协议，只有在InnoDB引擎下存在，是一种提高并发的技术。
- MVCC最大的好处：读不加锁，读写不冲突。在读多写少的OLTP应用中，读写不冲突是非常重要的，极大的增加了系统的并发性能。

## MVCC的实现机制

- MVCC的实现原理主要是依赖记录中的 3个隐式字段，undo日志 ，Read View 来实现的。

- InnoDB在每行数据都增加三个隐藏字段
  - 一个唯一行号(DB_ROW_ID)： 6byte，隐含的自增ID（隐藏主键），如果数据表没有主键，InnoDB会自动以DB_ROW_ID产生一个聚簇索
  - 一个记录的事务ID(DB_TRX_ID)：6byte，记录创建这条记录/最后一次修改该记录的事务ID
  - 一个记录回滚的版本号(DB_ROLL_PTR)：7byte，回滚指针，指向这条记录的上一个版本（存储于rollback segment里）
- 在多版本并发控制中，为了保证数据操作在多线程过程中，保证事务隔离的机制，降低锁竞争的压力，保证较高的并发量，在每开启一个事务时，会生成一个事务的版本号，**被操作的数据会生成一条新的数据行（临时）**，在提交前对其他事务是不可见的，对于数据的更新（包括增删改）操作成功，会将这个版本号更新到数据的行中，事务提交成功，将新的版本号更新到此数据行中，这样保证了每个事务操作的数据，都是互不影响的，也不存在锁的问题。

## MVCC解决的问题

- 在并发读写数据库时，可以做到在读(select)操作时不用阻塞写操作，写操作也不用阻塞读操作，提高了数据库并发读写的性能
- 解决脏读，幻读，不可重复读等事务隔离问题，但不能解决更新丢失问题
- MVCC与锁结合
  - MVCC + 悲观锁：MVCC解决读写冲突，悲观锁解决写写冲突
  - MVCC + 乐观锁：MVCC解决读写冲突，乐观锁解决写写冲突
  - 这种组合的方式就可以最大程度的提高数据库并发性能，并解决读写冲突，和写写冲突导致的问题

